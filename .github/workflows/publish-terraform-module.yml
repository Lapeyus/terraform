name: Publish Terraform Module

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  detect_and_publish:
    name: Detect Changes and Publish Module
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '14'

      - name: Detect Changed Modules
        id: changes
        run: |
          CHANGED_MODULES=$(git diff --name-only HEAD~1 HEAD | grep '^modules/' | cut -d'/' -f2 | sort -u)
          echo "Changed modules: $CHANGED_MODULES"
          echo "::set-output name=changed_modules::$CHANGED_MODULES"

      - name: Fail if no changes detected
        if: steps.changes.outputs.changed_modules == ''
        run: |
          echo "No changes detected in the modules folder. Exiting."
          exit 1

      - name: Compress and Upload Changed Modules
        if: steps.changes.outputs.changed_modules != ''
        run: |
          for module in ${{ steps.changes.outputs.changed_modules }}; do
            cd modules/$module
            tar -czvf $module.tar.gz *
            cd ../..
          done

      - name: Create GitHub Releases
        if: steps.changes.outputs.changed_modules != ''
        run: |
          for module in ${{ steps.changes.outputs.changed_modules }}; do
            gh release create "v1.0.0-$module" "modules/$module/$module.tar.gz" -t "Module $module Release" -n "Release for module $module"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
